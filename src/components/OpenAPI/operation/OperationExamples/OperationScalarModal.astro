---
import "@scalar/api-client/style.css";
---

<div id="scalar-container"></div>

<style>
  #scalar-modal-container :global(.scalar-app-exit) {
    background-color: rgba(0 0 0 / 0.8);
  }

  /* Fix conflict in tw 3 translate style coming from @scalar and our tw4 translate style. */
  :global([data-v-66325e68]) {
    translate: none;
  }
</style>

<script>
  import { createApiClientModal } from "@scalar/api-client/layouts/Modal";
  import type { ScalarModalOpenEvent } from "./types";
  import { observeThemeChange } from "~/lib/theme";
  import { ensureNonNullable } from "~/lib/ensureNonNullable";

  const scalarContainer = ensureNonNullable(
    document.getElementById("scalar-container"),
    "Scalar modal container not found!",
  );
  const servers = [
    {
      description: "testnet",
      url: "https://api.testnet.aptoslabs.com/v1",
    },
    {
      description: "mainnet",
      url: "https://api.mainnet.aptoslabs.com/v1",
    },
    {
      description: "devnet",
      url: "https://api.devnet.aptoslabs.com/v1",
    },
  ];
  const starlightThemeClassMap = {
    light: "light-mode",
    dark: "dark-mode",
  };

  observeThemeChange((theme) => {
    scalarContainer.classList.remove(...Object.values(starlightThemeClassMap));
    scalarContainer.classList.add(starlightThemeClassMap[theme]);
  });

  // Initialize modal once and reuse - the new sync API requires loading the spec separately
  let modalClient: ReturnType<typeof createApiClientModal>["client"] | null = null;
  let specLoaded = false;
  let specLoadAttempts = 0;
  const MAX_SPEC_LOAD_ATTEMPTS = 3;

  async function getModalClient() {
    if (!modalClient) {
      const { client } = createApiClientModal({
        el: scalarContainer,
        configuration: {
          servers,
          showSidebar: false,
          hideClientButton: true,
        },
      });
      modalClient = client;
    }

    // The new sync API doesn't load the spec automatically, we need to call updateConfig
    if (!specLoaded) {
      // Prevent repeated failures - allow retry up to MAX_SPEC_LOAD_ATTEMPTS
      if (specLoadAttempts >= MAX_SPEC_LOAD_ATTEMPTS) {
        throw new Error("Max spec load attempts exceeded. Please reload the page.");
      }

      try {
        specLoadAttempts++;
        await modalClient.updateConfig({
          url: "/aptos-spec.json",
          servers,
          showSidebar: false,
          hideClientButton: true,
        });
        specLoaded = true;
        specLoadAttempts = 0; // Reset on success
      } catch (error) {
        console.error(
          `Failed to load Scalar API spec (attempt ${specLoadAttempts}/${MAX_SPEC_LOAD_ATTEMPTS}):`,
          error,
        );
        specLoaded = false;
        throw error;
      }
    }

    return modalClient;
  }

  // Listen for modal open events
  document.addEventListener(
    "scalarModal:open",
    async function (e: ScalarModalOpenEvent) {
      try {
        const client = await getModalClient();
        client.open({ path: e.detail.operationPath, method: e.detail.method });
      } catch (error) {
        console.error("Failed to open Scalar API modal:", error);
        // Show a non-blocking notification to the user
        const message =
          specLoadAttempts >= MAX_SPEC_LOAD_ATTEMPTS
            ? "Failed to load API reference. Please reload the page and try again."
            : "Failed to open API reference. Please try again.";

        // Use a toast-style notification if available, otherwise fall back to console
        if (
          typeof window !== "undefined" &&
          "Notification" in window &&
          Notification.permission === "granted"
        ) {
          new Notification("API Reference Error", { body: message });
        }
      }
    },
    { passive: true },
  );
</script>
