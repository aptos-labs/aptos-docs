---
title: "Usando AWS"
description: "Despliega validator de Aptos y validator fullnode (VFN) en Amazon Web Services usando Terraform y EKS con instrucciones completas de configuración."
sidebar:
  label: "AWS"
---

import { Aside } from '@astrojs/starlight/components';

Esta es una guía paso a paso para desplegar un validator de Aptos y validator fullnode (VFN) usando Amazon Web Services (AWS). Usando esta guía,
el validator y VFN serán desplegados en máquinas separadas.

<Aside type="caution">
  **Prerrequisitos**<br />
  Antes de comenzar, asegúrate de leer y entender los [Requisitos del Nodo](/network/nodes/validator-node/node-requirements). Similarmente, asegúrate de haber
  instalado el [CLI de Aptos](/build/cli),
  [Terraform](https://www.terraform.io/downloads.html),
  [CLI de Kubernetes](https://kubernetes.io/docs/tasks/tools/),
  y [CLI de AWS](https://aws.amazon.com/cli/). Esta guía asume que ya tienes una cuenta de AWS configurada.
</Aside>

## Pasos de despliegue

<Aside type="note">
  **Conexión por defecto a mainnet**<br />
  Si sigues la configuración por defecto en este documento, entonces tu validator y VFN estarán conectados a la mainnet de Aptos.
  Para conectarte a una red de Aptos diferente, como testnet, asegúrate de descargar los archivos génesis y waypoint
  correctos para la red a la que quieres conectarte. Similarmente, necesitarás modificar los archivos Terraform para usar las
  configuraciones correctas (ej., `source`, `image_tag` y `chain_id`).
</Aside>

1. Crea un directorio de trabajo para tus nodos Aptos, y elige un nombre de usuario para tus nodos, ej.,

   ```shellscript filename="Terminal"
   export WORKSPACE=mainnet
   export USERNAME=alice
   mkdir ~/$WORKSPACE
   cd ~/$WORKSPACE
   ```

2. Crea un bucket de almacenamiento S3 para almacenar el estado de Terraform en AWS. Puedes hacer esto en la UI de AWS o usando el
   comando abajo:

   ```shellscript filename="Terminal"
   aws s3 mb s3://<bucket name> --region <region name>
   ```

3. Crea un archivo Terraform llamado `main.tf` en tu directorio de trabajo:

   ```shellscript filename="Terminal"
   cd ~/$WORKSPACE
   vi main.tf
   ```

4. Modifica el archivo `main.tf` para configurar Terraform y crear el módulo Terraform. Ver el ejemplo abajo:

   ```terraform filename="main.tf"
   terraform {
     required_version = "~> 1.3.6"
     backend "s3" {
       bucket = "terraform.aptos-node"
       key    = "state/aptos-node"
       region = <aws region>
     }
   }

   provider "aws" {
     region = <aws region>
   }

   module "aptos-node" {
     # Descargar el módulo Terraform del repositorio aptos-core.
     source        = "github.com/aptos-labs/aptos-core.git//terraform/aptos-node/aws"
     region        = <aws region>  # Especificar la región AWS
     # zone_id     = "<Route53 zone id>"  # Usar Route53 si quieres usar DNS
     era           = 1  # Incrementar el número de era para limpiar los datos de cadena
     chain_id      = 1  # Usar 1 para mainnet, o valores diferentes para otras redes.
     image_tag     = "mainnet" # Especificar el tag de imagen a usar basado en la red
     validator_name = "<Name of your validator>" # Especificar el nombre de tu validator
   }
   ```

   Para todas las opciones de personalización, ver:

   - Las variables Terraform: [https://github.com/aptos-labs/aptos-core/blob/main/terraform/aptos-node/aws/variables.tf](https://github.com/aptos-labs/aptos-core/blob/main/terraform/aptos-node/aws/variables.tf)
   - Los valores Helm: [https://github.com/aptos-labs/aptos-core/blob/main/terraform/helm/aptos-node/values.yaml](https://github.com/aptos-labs/aptos-core/blob/main/terraform/helm/aptos-node/values.yaml).

5. Inicializa Terraform en el directorio `$WORKSPACE` donde creaste el archivo `main.tf`.

   ```shellscript filename="Terminal"
   terraform init
   ```

   Esto descargará todas las dependencias de Terraform en la carpeta `.terraform` en tu directorio de trabajo actual.

6. Crea un nuevo workspace de Terraform para aislar tus entornos, y ver la lista de workspaces.

   ```shellscript filename="Terminal"
   terraform workspace new $WORKSPACE

   # Este comando listará todos los workspaces
   terraform workspace list
   ```

7. Aplica la configuración de Terraform.

   ```shellscript filename="Terminal"
   terraform apply
   ```

   Esto puede tomar un tiempo en terminar (ej., >20 minutos). Terraform creará todos los recursos en tu cuenta de nube.

8. Después de que `terraform apply` termine, puedes verificar si los recursos han sido creados correctamente, ejecutando los siguientes comandos:

   - `aws eks update-kubeconfig --name aptos-$WORKSPACE`: Este comando configurará acceso para tu cluster k8s.
   - `kubectl get pods`: Este comando mostrará todos los pods en el cluster. Deberías ver haproxy, el
     validator y el VFN (con el pod del validator y VFN `pending` debido a acción adicional en pasos posteriores).
   - `kubectl get svc`: Este comando mostrará todos los servicios en el cluster. Deberías ver el
     `validator-lb` y `fullnode-lb`, con una IP externa para conectividad de red.

9. Siguiente, necesitamos inyectar la información IP de tu nodo en tu entorno. Puedes hacer esto ejecutando los siguientes comandos:

   ```shellscript filename="Terminal"
   export VALIDATOR_ADDRESS="$(kubectl get svc ${WORKSPACE}-aptos-node-0-validator-lb --output jsonpath='{.status.loadBalancer.ingress[0].hostname}')"

   export FULLNODE_ADDRESS="$(kubectl get svc ${WORKSPACE}-aptos-node-0-fullnode-lb --output jsonpath='{.status.loadBalancer.ingress[0].hostname}')"
   ```

10. Ahora, genera los pares de claves para tus nodos en tu directorio de trabajo. Puedes hacer esto ejecutando
    el siguiente comando con el CLI de Aptos:

    ```shellscript filename="Terminal"
    aptos genesis generate-keys --output-dir ~/$WORKSPACE/keys
    ```

    Esto creará 4 archivos de clave bajo el directorio `~/$WORKSPACE/keys`:

    - `public-keys.yaml`: Este archivo contiene todas las claves públicas para tu validator y VFN, así como tu dirección de cuenta.
    - `private-keys.yaml`: Este archivo contiene todas las claves privadas para tu validator y VFN.
    - `validator-identity.yaml`: Este archivo contiene las claves públicas y privadas para tu validator, así como tu dirección de cuenta.
    - `validator-full-node-identity.yaml`: Este archivo contiene las claves públicas y privadas para tu VFN, así como tu dirección de cuenta.

    <Aside type="caution">
      **Respalda tus claves privadas**<br />
      Tus claves privadas son importantes para que establezcas propiedad de tus nodos. Nunca compartas tus claves **privadas** con nadie,
      y asegúrate de **respaldar** `private-keys.yaml` en algún lugar seguro.
    </Aside>

11. Siguiente, necesitarás establecer tu configuración de validator. Esto incluye establecer los nombres de host del validator y VFN,
    que pueden ser direcciones IP o direcciones DNS. Esto puede hacerse ejecutando el siguiente comando:

    ```shellscript filename="Terminal"
    aptos genesis set-validator-configuration \
      --local-repository-dir ~/$WORKSPACE \
      --username $USERNAME \
      --owner-public-identity-file ~/$WORKSPACE/keys/public-keys.yaml \
      --validator-host $VALIDATOR_ADDRESS:6180 \
      --full-node-host $FULLNODE_ADDRESS:6182 \
      --stake-amount 100000000000000
    ```

    Configurar el validator creará dos archivos YAML en el directorio `~/$WORKSPACE/$USERNAME`: `owner.yaml` y
    `operator.yaml`. Estos serán útiles para conectar tus nodos a la red de Aptos (después).

12. Descarga los siguientes archivos siguiendo las instrucciones en las páginas [Archivos del Nodo](/network/nodes/configure/node-files-all-networks).
    Necesitarás seleccionar la red apropiada (ej., `mainnet`, `testnet`, `devnet`) y descargar los siguientes archivos:

    - `genesis.blob`
    - `waypoint.txt`

13. Para recapitular, en tu directorio de trabajo (`~/$WORKSPACE`), deberías tener una lista de archivos:

    - `main.tf`: Los archivos Terraform para instalar el módulo `aptos-node`.
    - carpeta `keys` conteniendo:
      - `public-keys.yaml`: Claves públicas para ambos nodos.
      - `private-keys.yaml`: Claves privadas para ambos nodos.
      - `validator-identity.yaml`: Información de clave y cuenta para el validator.
      - `validator-full-node-identity.yaml`: Información de clave y cuenta para el VFN.
    - carpeta `$username` conteniendo:
      - `owner.yaml`: Los mapeos de propietario, operador y votante.
      - `operator.yaml`: Información del operador del validator y VFN.
    - `waypoint.txt`: El waypoint para la transacción génesis en la red a la que te estás conectando.
    - `genesis.blob` El blob génesis para la red a la que te estás conectando.

14. Finalmente, inserta el `genesis.blob`, `waypoint.txt` y los archivos de identidad como secretos en el cluster k8s,
    ejecutando el siguiente comando:

    ```shellscript filename="Terminal"
    kubectl create secret generic ${WORKSPACE}-aptos-node-0-genesis-e1 \
        --from-file=genesis.blob=genesis.blob \
        --from-file=waypoint.txt=waypoint.txt \
        --from-file=validator-identity.yaml=keys/validator-identity.yaml \
        --from-file=validator-full-node-identity.yaml=keys/validator-full-node-identity.yaml
    ```

    <Aside type="caution">
      **Números de era y volúmenes colgantes**<br />
      El sufijo `-e1` en el comando anterior se refiere al número de era. Si cambiaste el número `era`, asegúrate de que coincida
      cuando crees los secretos.

      La `era` es un concepto relevante solo para despliegues Kubernetes de un nodo Aptos.
      Cambiar la `era` proporciona una forma fácil de limpiar el estado de tu despliegue (ej., datos de blockchain). Sin embargo, esto puede
      llevar a volúmenes persistentes colgantes. Confirma la existencia de cualquier volumen colgante con `kubectl get pvc`
      y elimina cualquier volumen colgante manualmente para minimizar costos.
    </Aside>

15. Ahora, deberíamos poder ver que todos los pods están ejecutándose, incluyendo el validator y VFN. Puedes verificar esto
    ejecutando el siguiente comando:

    ```shellscript filename="Terminal"
    kubectl get pods

    # Salida de ejemplo
    NAME                                        READY   STATUS    RESTARTS   AGE
    node1-aptos-node-0-fullnode-e9-0              1/1     Running   0          4h31m
    node1-aptos-node-0-haproxy-7cc4c5f74c-l4l6n   1/1     Running   0          4h40m
    node1-aptos-node-0-validator-0                1/1     Running   0          4h30m
    ```

<Aside type="caution">
  **Siguientes pasos**<br />
  Ahora has completado la configuración de tu validator y VFN usando AWS. Sin embargo, tus nodos aún no podrán conectarse
  a la red de Aptos.
</Aside>

## Conectarse a la Red de Aptos

Ahora has completado la configuración de tu validator y VFN usando AWS. Procede a [Conectar Nodos](/network/nodes/validator-node/connect-nodes) para los siguientes pasos.
