---
title: "Gaz et Frais de Stockage"
description: "Apprenez les frais de gaz et co√ªts de stockage sur Aptos, incluant les co√ªts d'ex√©cution, frais de stockage, tarification du gaz, et strat√©gies d'optimisation pour des transactions efficaces."
sidebar:
  label: "Gaz & Frais de Stockage"
---

import { Aside } from '@astrojs/starlight/components';

Toute ex√©cution de transaction sur la blockchain Aptos n√©cessite des frais de traitement. √Ä ce jour, ces frais comprennent deux composants :

1. Co√ªts d'ex√©cution & IO

- Cela couvre votre utilisation des ressources de calcul transitoires, telles que le traitement de vos transactions et la propagation de l'enregistrement valid√© √† travers le r√©seau distribu√© du mainnet.
- Il est mesur√© en Unit√©s de Gaz dont le prix peut fluctuer selon la charge du r√©seau. Cela permet aux co√ªts d'ex√©cution et IO d'√™tre bas lorsque le r√©seau est moins occup√©.
- Cette portion de gaz est br√ªl√©e d√©finitivement lors de l'ex√©cution d'une transaction.

2. Frais de stockage

- Cela couvre le co√ªt pour stocker de mani√®re persistante l'enregistrement valid√© dans le stockage distribu√© de la blockchain.
- Il est mesur√© en prix APT fixes, donc le co√ªt de stockage permanent reste stable m√™me lorsque le prix unitaire du gaz fluctue avec la charge transitoire du r√©seau.
- Les frais de stockage peuvent √™tre rembours√©s lorsque l'emplacement de stockage allou√© est supprim√©. Actuellement, le r√©seau est configur√© pour rembourser la totalit√© des frais de stockage pay√©s sur la dur√©e de vie d'un emplacement de stockage d'√©tat.
- Pour garder l'impl√©mentation syst√®me simple, cette portion de gaz est br√ªl√©e et frapp√©e √† nouveau lors du remboursement.

<Aside type="note">
  Conceptuellement, ces frais peuvent √™tre pens√©s comme assez similaires √† comment nous payons pour nos services domestiques d'√©lectricit√© ou d'eau.
</Aside>

## Unit√© de gaz

Les transactions peuvent aller du simple et peu co√ªteux au compliqu√© selon ce qu'elles font. Dans la blockchain Aptos, une **unit√© de gaz** repr√©sente une unit√© de base de consommation pour les ressources transitoires, telles que faire du calcul ou acc√©der au stockage. Ce dernier ne devrait pas √™tre confondu avec l'aspect de stockage √† long terme de telles op√©rations, car cela est couvert par les frais de stockage s√©par√©ment.

Voir [Comment le Gaz de Base Fonctionne](/network/blockchain/base-gas) pour une description d√©taill√©e des types de frais de gaz et optimisations disponibles.

<Aside type="note">
  üëâ Une **unit√© de gaz** est un nombre sans dimension ou une unit√© qui n'est pas associ√©e √† un √©l√©ment tel qu'une pi√®ce, exprim√©e comme un entier. Les unit√©s de gaz totales consomm√©es par votre transaction d√©pendent de la complexit√© de votre transaction. Le **prix du gaz**, d'autre part, est exprim√© en termes de pi√®ce native de la blockchain Aptos [APT](/network/glossary#apt) et sa sous-unit√© [Octas](/network/glossary#octa). Voir aussi [Transactions et √âtats](/network/blockchain/txns-states) pour l'apparence d'une transaction soumise √† la blockchain Aptos.
</Aside>

## Le Relev√© de Frais

Depuis la version 1.7 d'Aptos Framework, la r√©partition des frais charg√©s et remboursements est √©mise comme un √©v√©nement de module repr√©sent√© par la struct `0x1::transaction_fee::FeeStatement`.

```move filename="transaction_fee.move"
#[event]
/// R√©partition des frais charg√©s et remboursements pour une transaction.
/// La structure est :
///
/// - Charge nette ou remboursement (pas dans le relev√©)
///    - charge totale : total_charge_gas_units, correspond √† `gas_used` dans le on-chain `TransactionInfo`.
///      Ceci est la somme des sous-√©l√©ments ci-dessous. Notez qu'il y a une perte potentielle de pr√©cision quand
///      la conversion entre unit√©s de gaz internes et externes et entre unit√©s de gaz et pi√®ces natives,
///      donc il est possible que les nombres ne s'ajoutent pas exactement. -- Ce nombre est la charge finale,
///      tandis que la r√©partition est seulement informative.
///        - frais de gaz pour ex√©cution (temps CPU) : `execution_gas_units`
///        - frais de gaz pour IO (acc√®s al√©atoire au stockage) : `io_gas_units`
///        - frais de stockage charg√©s (espace de stockage) : `storage_fee_octas`, √† inclure dans
///          `total_charge_gas_unit`, ce nombre est converti en unit√©s de gaz selon le
///          `gas_unit_price` sp√©cifi√© par l'utilisateur sur la transaction.
///    - remboursement de suppression de stockage : `storage_fee_refund_octas`, ceci n'est pas inclus dans `gas_used` ou
///      `total_charge_gas_units`, la charge nette / remboursement est calcul√©e par
///      `total_charge_gas_units` * `gas_unit_price` - `storage_fee_refund_octas`.
///
/// Ceci est destin√© √† √™tre √©mis comme un √©v√©nement de module.
struct FeeStatement has drop, store {
    /// Charge totale de gaz.
    total_charge_gas_units: u64,
    /// Charge de gaz d'ex√©cution.
    execution_gas_units: u64,
    /// Charge de gaz IO.
    io_gas_units: u64,
    /// Frais de stockage charg√©s.
    storage_fee_octas: u64,
    /// Remboursement des frais de stockage.
    storage_fee_refund_octas: u64,
}
```

## Prix du gaz et priorisation des transactions

Dans le r√©seau Aptos, la gouvernance Aptos d√©finit le prix unitaire minimum absolu du gaz. Cependant, le march√© d√©termine la rapidit√© avec laquelle une transaction avec un prix unitaire particulier de gaz est trait√©e. Voir [Ethereum Gas Tracker](https://etherscan.io/gastracker), par exemple, qui montre les mouvements de prix du march√© du prix du gaz Ethereum.

En sp√©cifiant un prix unitaire de gaz plus √©lev√© que le prix actuel du march√©, vous pouvez **augmenter** le niveau de priorit√© pour votre transaction sur la blockchain en payant des frais de traitement plus importants. Dans le cadre du consensus, lorsque le leader s√©lectionne des transactions de son mempool pour proposer dans le prochain bloc, il priorisera la s√©lection des transactions avec un prix unitaire de gaz plus √©lev√©. Veuillez noter que des frais de gaz plus √©lev√©s ne priorisent que la s√©lection de transaction pour le prochain bloc.

Cependant, dans un bloc, l'ordre d'ex√©cution des transactions est d√©termin√© par le syst√®me. Cet ordre est bas√© sur [le brassage de transactions](https://github.com/aptos-foundation/AIPs/blob/main/aips/aip-27.md), ce qui rend l'ex√©cution parall√®le plus efficace en consid√©rant les patterns de conflit. Bien que dans la plupart des cas cela soit inutile, si le r√©seau est sous charge cette mesure peut assurer que votre transaction est trait√©e plus rapidement. Voir l'entr√©e `gas_unit_price` sous [Estimation des unit√©s de gaz via simulation](#estimation-des-unit√©s-de-gaz-via-simulation) pour les d√©tails.

<Aside type="caution">
  üëâ Si vous augmentez le prix unitaire du gaz, mais avez des transactions en vol (non valid√©es) pour le m√™me compte, vous devriez ressoumettre toutes ces transactions avec le prix unitaire de gaz plus √©lev√©. Ceci parce que les transactions dans le m√™me compte doivent toujours respecter le num√©ro de s√©quence, donc effectivement la transaction avec prix unitaire de gaz plus √©lev√© n'augmentera la priorit√© qu'apr√®s que les transactions en vol soient incluses dans un bloc.
</Aside>

## Sp√©cification des frais de gaz dans une transaction

Lorsqu'une transaction est soumise √† la blockchain Aptos, la transaction doit contenir les champs de gaz obligatoires suivants :

- `max_gas_amount` : Le nombre maximum d'unit√©s de gaz que l'exp√©diteur de transaction est pr√™t √† d√©penser pour ex√©cuter la transaction. Ceci d√©termine les ressources computationnelles et de stockage maximum qui peuvent √™tre consomm√©es par la transaction.
- `gas_price` : Le prix par unit√© de gaz que l'exp√©diteur de transaction est pr√™t √† payer. Il est exprim√© en [Octas](/network/glossary#octa).

  Pendant l'ex√©cution de la transaction, le montant total de gaz, exprim√© comme :

  ```text
  (unit√©s de gaz d'ex√©cution totales consomm√©es) + (unit√©s de gaz de stockage totales consomm√©es)
  ```

  ne doit pas d√©passer `max_gas_amount`, sinon la transaction avortera l'ex√©cution.

Les frais de transaction factur√©s au client seront au plus `gas_price * max_gas_amount`.

## Param√®tres de gaz d√©finis par la gouvernance

Les param√®tres de gaz suivants sont d√©finis par la gouvernance Aptos.

<Aside type="note">
  Ces param√®tres de gaz on-chain sont publi√©s sur la blockchain Aptos √† `0x1::gas_schedule::GasScheduleV2`.
</Aside>

- `txn.maximum_number_of_gas_units` : Nombre maximum d'unit√©s de gaz qui peuvent √™tre d√©pens√©es (c'est la valeur maximum autoris√©e pour le param√®tre de gaz `max_gas_amount` dans la transaction). Ceci est pour assurer que les ajustements de tarification dynamique n'exc√®dent pas ce que vous √™tes pr√™t √† payer au total.
- `txn.min_transaction_gas_units` : Nombre minimum d'unit√©s de gaz qui peuvent √™tre d√©pens√©es. La valeur `max_gas_amount` dans la transaction doit √™tre d√©finie √† plus que la valeur de ce param√®tre.

Il existe aussi quelques limites globales par cat√©gorie :

- `txn.max_execution_gas` : Le nombre maximum d'unit√©s de gaz qu'une transaction peut d√©penser sur l'ex√©cution.
- `txn.max_io_gas` : Le nombre maximum d'unit√©s de gaz qu'une transaction peut d√©penser sur IO.
- `txn.max_storage_fee` : Le montant maximum d'APT qu'une transaction peut d√©penser sur le stockage persistant.
  Ces limites aident √† d√©coupler une cat√©gorie d'une autre, nous permettant de d√©finir `txn.maximum_number_of_gas_units` g√©n√©reusement sans avoir √† nous inqui√©ter des abus.

## Calcul des Frais de Stockage

Les frais de stockage pour une transaction sont factur√©s selon le nombre de nouveaux emplacements allou√©s dans l'√©tat global et l'augmentation de taille dans les emplacements existants.

Il y a quelques nuances concernant le changement de prix et les emplacements h√©rit√©s qui n'ont pas pay√© pour la taille de l'emplacement en dessous d'un "quota gratuit" historique. R√©f√©rez-vous √† [AIP-65](https://github.com/aptos-foundation/AIPs/blob/main/aips/aip-65.md#specification) pour plus de d√©tails.

Il devrait aussi √™tre not√© que pour des raisons de compatibilit√© arri√®re, les frais de stockage total d'une transaction sont actuellement pr√©sent√©s au client comme faisant partie du total `gas_used`. Cela signifie, ce montant pourrait varier bas√© sur le prix unitaire du gaz m√™me pour la m√™me transaction.

Voici un exemple. Supposez que nous avons une transaction qui co√ªte `100` unit√©s de gaz en ex√©cution & IO, et `5000` [Octas](/network/glossary#octa) en frais de stockage. Le r√©seau montrera que vous avez utilis√©

- `100 + 5000 / 100 = 150` unit√©s de gaz si le prix unitaire du gaz est `100`, ou
- `100 + 5000 / 200 = 125` unit√©s de gaz si le prix unitaire est `200`.

Nous sommes conscients de la confusion que cela pourrait cr√©er, et pr√©voyons de pr√©senter ceux-ci comme des √©l√©ments s√©par√©s dans le futur. Cependant, cela n√©cessitera quelques changements au format de sortie de transaction et aux clients en aval, donc veuillez √™tre patient pendant que nous travaillons dur pour faire cela arriver.

## Calcul du Remboursement de Suppression de Stockage

Si une transaction supprime des √©l√©ments d'√©tat, un remboursement est √©mis au payeur de transaction pour les emplacements de stockage lib√©r√©s. Actuellement, un remboursement complet est √©mis -- c'est-√†-dire, tous les frais de stockage pay√©s pour l'emplacement et octets de l'√©l√©ment sur la dur√©e de vie de celui-ci.

Le montant du remboursement est d√©nomm√© en APT et n'est pas converti en unit√©s de gaz ou inclus dans le total `gas_used`. Au lieu de cela, ce montant de remboursement est sp√©cifiquement d√©taill√© dans le champ `storage_fee_refund_octas` du [`FeeStatement`](#le-relev√©-de-frais). En cons√©quence, l'effet net de la transaction sur le solde APT du payeur est d√©termin√© par `gas_used * gas_unit_price - storage_refund`. Si le r√©sultat est positif, il y a une d√©duction du solde du compte ; si n√©gatif, il y a un d√©p√¥t.

## Exemples

### Exemple 1 : Solde du compte vs frais de transaction

**Le compte de l'exp√©diteur doit avoir des fonds suffisants pour payer les frais de transaction.**

Si, disons, vous transf√©rez tout l'argent de votre compte pour qu'il ne vous reste aucun solde pour payer les frais de transaction. Dans un tel cas la blockchain Aptos vous ferait savoir que la transaction √©chouerait, et votre transfert ne r√©ussirait pas non plus.

### Exemple 2 : Montants de transaction vs frais de transaction

**Les frais de transaction sont ind√©pendants des montants de transfert dans la transaction.**

Dans une transaction, par exemple, transaction A, vous transf√©rez 1000 pi√®ces d'un compte √† un autre compte. Dans une deuxi√®me transaction B, avec les m√™mes valeurs de champ de gaz de la transaction A, vous transf√©rez maintenant 100,000 pi√®ces d'un compte √† un autre compte. En supposant que les deux transactions A et B sont envoy√©es approximativement au m√™me moment, alors les co√ªts de gaz pour les transactions A et B seraient pr√®s d'identiques.

## Estimation de la consommation de gaz via simulation

Le gaz utilis√© pour une transaction peut √™tre estim√© en simulant la transaction on-chain comme d√©crit ici ou localement via la fonctionnalit√© de profilage de gaz de l'APT CLI. Les r√©sultats de la transaction simul√©e repr√©sentent le montant **exact** qui est n√©cessaire √† l'**√©tat exact** de la blockchain au moment de la simulation. Ces unit√©s de gaz utilis√©es peuvent changer bas√© sur l'√©tat de la cha√Æne. Pour cette raison, tout montant venant de la simulation n'est qu'une estimation, et quand d√©finir le montant maximum de gaz, il devrait inclure un montant appropri√© d'espace bas√© sur votre niveau de confort et comportements historiques. D√©finir le montant maximum de gaz trop bas r√©sultera en l'avortement de la transaction et le compte √©tant factur√© pour quel que soit le gaz qui a √©t√© consomm√©.

Pour simuler les transactions on-chain, utilisez l'API [`SimulateTransaction`](https://api.devnet.aptoslabs.com/v1/spec#/operations/simulate_transaction). Cette API ex√©cutera la transaction exacte que vous pr√©voyez d'ex√©cuter.

Pour simuler la transaction localement, utilisez le profileur de gaz, qui est int√©gr√© dans l'APT CLI.
Ceci g√©n√©rera un rapport bas√© sur le web pour vous aider √† comprendre l'usage pr√©cis du gaz de votre transaction.
Voir [Profilage de Gaz](/build/cli/working-with-move-contracts/local-simulation-benchmarking-and-gas-profiling#gas-profiling) pour plus de d√©tails.

<Aside type="note">
  Notez que la `Signature` fournie sur la transaction doit √™tre tous des z√©ros. Ceci est pour emp√™cher quelqu'un d'utiliser la signature valide.
</Aside>

Pour simuler la transaction, il y a deux flags :

1. `estimate_gas_unit_price` : Ce flag estimera le prix unitaire du gaz dans la transaction utilisant le m√™me algorithme que l'API [`estimate_gas_price`](https://api.devnet.aptoslabs.com/v1/spec#/operations/estimate_gas_price).
2. `estimate_max_gas_amount` : Ce flag trouvera le gaz maximum possible que vous pouvez utiliser, et il simulera la transaction pour vous dire le `gas_used` r√©el.

### √âtapes de simulation

Les √©tapes de simulation pour trouver le montant correct de gaz pour une transaction sont comme suit :

1. Estimez le gaz via simulation avec √† la fois `estimate_gas_unit_price` et `estimate_max_gas_amount` d√©finis √† `true`.
2. Utilisez le `gas_unit_price` dans la transaction retourn√©e comme votre nouveau `gas_unit_price` de transaction.
3. Voyez les valeurs `gas_used * gas_unit_price` dans la transaction retourn√©e comme la **borne inf√©rieure** pour le co√ªt de la transaction.
4. Pour calculer la borne sup√©rieure du co√ªt, prenez le **minimum** du `max_gas_amount` dans la transaction retourn√©e, et du `gas_used * facteur de s√©curit√©`. Dans la CLI une valeur de `1.5` est utilis√©e pour `facteur de s√©curit√©`. Utilisez cette valeur comme `max_gas_amount` pour la transaction que vous voulez soumettre. Notez que la **borne sup√©rieure** pour le co√ªt de la transaction est `max_gas_amount * gas_unit_price`, i.e., c'est le plus que l'exp√©diteur de la transaction est factur√©.
5. √Ä ce point vous avez maintenant votre `gas_unit_price` et `max_gas_amount` pour soumettre votre transaction comme suit :
   1. `gas_unit_price` de la transaction simul√©e retourn√©e.
   2. `max_gas_amount` comme le minimum du `gas_used` \* `un facteur de s√©curit√©` ou du `max_gas_amount` de la transaction.
6. Si vous sentez le besoin de prioriser ou d√©prioriser votre transaction, ajustez le `gas_unit_price` de la transaction. Augmentez la valeur pour une priorit√© plus √©lev√©e, et diminuez la valeur pour une priorit√© plus basse.

<Aside type="note">
  La priorisation est bas√©e sur des compartiments de `gas_unit_price`. Les compartiments sont d√©finis dans [`mempool_config.rs`](https://github.com/aptos-labs/aptos-core/blob/30b385bf38d3dc8c4e8ee0ff045bc5d0d2f67a85/config/src/config/mempool_config.rs#L8). Les compartiments actuels sont `[0, 150, 300, 500, 1000, 3000, 5000, 10000, 100000, 1000000]`. Par cons√©quent, un `gas_unit_price` de 150 et 299 serait prioris√© presque le m√™me.
</Aside>

<Aside type="note">
  Notez que le `facteur de s√©curit√©` ne prend en consid√©ration que les changements li√©s √† l'ex√©cution et IO. La cr√©ation inattendue d'emplacements de stockage peut ne pas √™tre suffisamment couverte.
</Aside>
