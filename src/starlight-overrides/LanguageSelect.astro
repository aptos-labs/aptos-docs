---
import Default from "@astrojs/starlight/components/LanguageSelect.astro";
---

<Default {...Astro.props}><slot /></Default>

<script>
  function initLanguageSelect() {
    // Find ALL language select elements
    const langSelects = document.querySelectorAll<HTMLSelectElement>(
      "starlight-lang-select select",
    );

    if (langSelects.length > 0) {
      // Add our enhanced handler to each select element
      langSelects.forEach((langSelect) => {
        // Skip if already initialized
        if (langSelect.dataset.langSelectInit) return;
        langSelect.dataset.langSelectInit = "true";

        langSelect.addEventListener("change", (e) => {
          if (e.currentTarget instanceof HTMLSelectElement) {
            // Get the selected locale from the pathname
            const pathname = e.currentTarget.value;
            const localeMatch = pathname.match(/^\/(es|zh|ja)/);
            const locale = localeMatch ? localeMatch[1] : "en";

            // Set the cookie with a 1-year expiration
            const expiryDate = new Date();
            expiryDate.setFullYear(expiryDate.getFullYear() + 1);
            document.cookie = `preferred_locale=${locale}; expires=${expiryDate.toUTCString()}; path=/; SameSite=Lax`;

            // Navigate to the new language path while preserving the URL fragment (hash)
            // This fixes a bug where fragments like #section were lost when switching languages
            const hash = window.location.hash;
            window.location.href = pathname + hash;

            // Prevent the default Starlight handler from also executing
            e.stopImmediatePropagation();
          }
        });
      });
    }
  }

  // Initialize on first load
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initLanguageSelect);
  } else {
    initLanguageSelect();
  }

  // Re-initialize after View Transition navigation (register listener only once)
  const win = window as Window & { __starlightLanguageSelectPageLoadInit?: boolean };
  if (!win.__starlightLanguageSelectPageLoadInit) {
    win.__starlightLanguageSelectPageLoadInit = true;
    document.addEventListener("astro:page-load", initLanguageSelect);
  }
</script>
